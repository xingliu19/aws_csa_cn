# 虚拟私有云（VPC）

Amazon VPC是Amazon Elastic Compute Cloud（Amazon EC2）的网络层，它允许您在AWS内构建自己的虚拟网络。 在虚拟网络中，您可以自主配置网络架构，包括定义IP地址范围； 创建子网，路由表，网关和安全策略。 在一个区域内，您可以创建多个VPC，并且每个VPC在逻辑上是隔离的，几遍它们共享IP地址和存储空间。

创建VPC时，必须通过选择无类域间路由（CIDR）块（例如10.0.0.0/16）来指定IPv4地址范围。 创建之后，将不能更改VPC的地址范围。 VPC地址范围在/ 16（可用地址65,536个）到/ 28（可用地址16个）之间，且不能与即将与其连接的其他网络发生重叠。

由于VPC服务发布晚于EC2，因此AWS提供了两种不同的组网方式：EC2-Classic和EC2-VPC。EC2-Classic是一个实例共享的网络，其设计愿意是用来启动EC2实例，在VPC出现之前。在2013年12月后创建的AWS账户就只能通过VPC来启动实例了。AWS为账户在每个区域都创建了一个VPC，并且创建了一个子网。

VPC由以下组件组成：

子网

路线表

动态主机配置协议（DHCP）选项集

安全组

网络访问控制列表（ACL）

VPC同时具有以下可选组件：

互联网网关（IGW）

弹性IP（EIP）地址

弹性网络接口（ENI）

Endpoints

Peering

网络地址转换（NAT）实例和NAT网关

虚拟专用网关（VPG），客户网关（CGW）和虚拟专用网络（VPN）

# 子网（Subnets）

子网是VPC IP地址范围的一部分，您可以在其中启动EC2实例，RDS数据库和其他AWS资源。 CIDR块用来定义子网（例如10.0.1.0/24和192.168.0.0/24）。您可以创建的最小子网是/ 28（拥有16个IP地址）。 AWS为每个子网保留前四个IP地址和最后一个IP地址用于内部联网。

创建VPC之后，您可以在每个可用区中添加一个或多个子网。 子网位于一个可用区中，并且不能跨越区域。 这一点非常重要，请记住，一个子网等于一个可用区。 但是，一个可用区中可具有多个子网。

子网可以分为公用，专用或VPN专属子网。 公共子网是一个公用子网，其路由表（稍后讨论）将子网的流量定向到VPC的IGW（也将在后面讨论）。 专用子网的路由表不会将子网的流量定向到VPC的IGW。 “VPN专属”子网关联的路由表则将子网的流量定向到VPC的VPG（稍后讨论）。

无论子网的类型如何，子网的内部IP地址范围始终是私有的（即，在Internet上不可抵达）。默认Amazon VPC在该区域内的每个可用区中都包含一个公共子网，其子网掩码为/ 20。

# 路由表（Route Tables）

路由表是Amazon VPC中的逻辑结构，其中包含一组应用于子网的规则（称为路由），该规则用于确定将网络流量导向何处。 路由表的路由允许Amazon VPC内不同子网中的Amazon EC2实例相互通信。 您在路由表中修改并添加自定义路由。 您还可以使用路由表来指定哪些子网是公共的（导向IGW）和哪些子网是私有的（非IGW的路由）。

每个路由表均包含一个称为本地路由的默认路由，该默认路由无法修改或删除，可在Amazon VPC中进行通信。 您可以添加其他路由，以引导流量通过IGW（稍后讨论），VPG（稍后讨论）或NAT实例（稍后讨论）退出Amazon VPC。

关于路由表，以下关键点须牢记：

• VPC具有隐式路由器。

• VPC默认带有一个主路由表，您可以对其进行修改。

• 可以为VPC创建其他自定义路由表。

• 每个子网必须与一个路由表相关联。 如果您未将子网与特定的路由表明确关联，则该子网使用主路由表。

• 主路由表可被自定义路由表替换，以便每个新子网将自动与其关联。

表中的每个路由都指定一个目标CIDR和一个目标。

# Internet网关

Internet网关（IGW）是水平扩展高度可用的Amazon VPC组件，它是Amazon VPC实例与Internet通信的桥梁。 IGW在您的Amazon VPC路由表中为可路由Internet的流量提供了目标，并且它为已分配了公共IP地址的实例执行网络地址转换。

在VPC中, EC2实例仅知道其私有IP地址。 当流量从实例发送到Internet时，IGW会将返回地址转换为实例的公用IP地址（或EIP地址，稍后介绍），并维护实例专用IP地址和公用IP地址的一对一映射。 当实例从Internet接收流量时，IGW会将目标地址（公共IP地址）转换为实例的私有IP地址，并将流量转发到Amazon VPC。

您必须执行以下操作才能创建可以访问Internet的公共子网：

• 将IGW附加到您的Amazon VPC。

• 创建一个子网路由表规则，以将所有非本地流量（0.0.0.0/0）发送到IGW。

• 配置网络ACL和安全组规则，以允许相关流量往返于您的实例。

您必须执行以下操作才能使Amazon EC2实例能够从Internet发送和接收流量：

• 分配公共IP地址或EIP地址。

您可以将路由范围扩展到路由表（0.0.0.0/0）中的所有目标，也可以将路由范围缩小到较小的IP地址范围。

# DHCP 选项集合

动态主机配置协议 \(DHCP\) 提供了将配置信息传递到 TCP/IP 网络中主机的标准。DHCP消息的选项字段包含配置参数。 其中一些参数是域名，域名服务器和netbios-node-type。

在您创建Amazon VPC时，AWS会自动创建并关联DHCP选项集，并设置两个选项：域名服务器（默认为AmazonProvidedDNS）和域名（默认为您所在地区的域名）。

DHCP选项set元素允许您将Amazon EC2主机名指向您自己的资源。  您可以在DHCP选项集中配置以下值：

• domain-name-servers——最多四台域名服务器 \(即 AmazonProvidedDNS\) 的 IP 地址。默认 DHCP 选项集指定 AmazonProvidedDNS。如果指定的域名服务器不止一台，请使用逗号将它们隔开。尽管可以指定最多四个域名服务器，但请注意，某些操作系统可能会施加较低的限制。如果要让实例接收 domain-name 中指定的自定义 DNS 主机名，则必须将 domain-name-servers 设置为自定义 DNS 服务器。

• domain-name——如果您是在 us-east-1 中使用 AmazonProvidedDNS，请指定 ec2.internal。如果您是在其他区域中使用 AmazonProvidedDNS，请指定 region.compute.internal（例如 ap-northeast-1.compute.internal）。否则，请指定域名 \(例如 example.com\)。该值用于完成非限定的 DNS 主机名。

• ntp-servers——最多四个网络时间协议 \(NTP\) 服务器的 IP 地址。

• netbios-name-servers——最多四个 NetBIOS 名称服务器的 IP 地址。

• netbios-node-type——NetBIOS 节点类型 \(1、2、4 或 8\)。

# Elastic IP Addresses

AWS在每个区域均维护一个公共IP地址资源池，您可以将其与VPC中的资源关联。 弹性IP地址（EIP）是池中用于分配、释放的静态公共IP地址。 EIP允许您维护一组固定的IP地址，而不受架构变化影响。使用EIP有以下要点：

您须先分配一个EIP，然后才能将其链接到实例；

EIP是在特定区域内的，不可跨区使用；

您可以将EIP转移给另一个实例使用；

EIP与您的账号关联，直到释放为止；

EIP分配即收费。

# Elastic Network Interfaces

弹性网络接口（ENI）是一个虚拟网络接口，可以附加到VPC中的实例。ENI仅在VPC中可用，并且在创建时便与子网关联。他们具有一个公用IP和多个私有IP。如果他们拥有多个私有IP，则有一个是主要地址。通过分配多个网络接口，使实例拥有多个网卡（虚拟）。ENI不依附于实例存在，如果实例失效，可将其转移到别的实例。



# Peering

Peering是两个VPC之间的对等连接，使VPC可以像在同一个网络中通信。Peering可以在您自己创建的VPC间建立，也可以是在同一个区域里的不同账户常见的VPC。Peering不是网关，也不是VPN，不会引入通信单点故障。

Peering通过请求/接收协议实现，由VPC管理者向其他VPC发送请求来发起Peering连接。如果VPC在同一个账户下，请求由VPC ID标识，若在不同账户，则由账户ID+VPC ID组成识别key值。接收者有一个星期的时间来决定接受/拒绝连接请求，或者在请求失效时间之前。

Peering不支持传递，即假设有VPC A,B,C。A和B连接，B和C连接，但A不能因此而能够与C通信，因为Peering不支持传递，必须显示创建A和C的连接。

