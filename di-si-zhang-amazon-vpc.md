# 虚拟私有云（VPC）

Amazon VPC是Amazon Elastic Compute Cloud（Amazon EC2）的网络层，它允许您在AWS内构建自己的虚拟网络。 在虚拟网络中，您可以自主配置网络架构，包括定义IP地址范围； 创建子网，路由表，网关和安全策略。 在一个区域内，您可以创建多个VPC，并且每个VPC在逻辑上是隔离的，几遍它们共享IP地址和存储空间。

创建VPC时，必须通过选择无类域间路由（CIDR）块（例如10.0.0.0/16）来指定IPv4地址范围。 创建之后，将不能更改VPC的地址范围。 VPC地址范围在/ 16（可用地址65,536个）到/ 28（可用地址16个）之间，且不能与即将与其连接的其他网络发生重叠。

由于VPC服务发布晚于EC2，因此AWS提供了两种不同的组网方式：EC2-Classic和EC2-VPC。EC2-Classic是一个实例共享的网络，其设计愿意是用来启动EC2实例，在VPC出现之前。在2013年12月后创建的AWS账户就只能通过VPC来启动实例了。AWS为账户在每个区域都创建了一个VPC，并且创建了一个子网。

VPC由以下组件组成：

子网

路线表

动态主机配置协议（DHCP）选项集

安全组

网络访问控制列表（ACL）

VPC同时具有以下可选组件：

互联网网关（IGW）

弹性IP（EIP）地址

弹性网络接口（ENI）

Endpoints

Peering

网络地址转换（NAT）实例和NAT网关

虚拟专用网关（VPG），客户网关（CGW）和虚拟专用网络（VPN）

# 子网（Subnets）

子网是VPC IP地址范围的一部分，您可以在其中启动EC2实例，RDS数据库和其他AWS资源。 CIDR块用来定义子网（例如10.0.1.0/24和192.168.0.0/24）。您可以创建的最小子网是/ 28（拥有16个IP地址）。 AWS为每个子网保留前四个IP地址和最后一个IP地址用于内部联网。

创建VPC之后，您可以在每个可用区中添加一个或多个子网。 子网位于一个可用区中，并且不能跨越区域。 这一点非常重要，请记住，一个子网等于一个可用区。 但是，一个可用区中可具有多个子网。

子网可以分为公用，专用或VPN专属子网。 公共子网是一个公用子网，其路由表（稍后讨论）将子网的流量定向到VPC的IGW（也将在后面讨论）。 专用子网的路由表不会将子网的流量定向到VPC的IGW。 “VPN专属”子网关联的路由表则将子网的流量定向到VPC的VPG（稍后讨论）。

无论子网的类型如何，子网的内部IP地址范围始终是私有的（即，在Internet上不可抵达）。默认Amazon VPC在该区域内的每个可用区中都包含一个公共子网，其子网掩码为/ 20。

# 路由表（Route Tables）

路由表是Amazon VPC中的逻辑结构，其中包含一组应用于子网的规则（称为路由），该规则用于确定将网络流量导向何处。 路由表的路由允许Amazon VPC内不同子网中的Amazon EC2实例相互通信。 您在路由表中修改并添加自定义路由。 您还可以使用路由表来指定哪些子网是公共的（导向IGW）和哪些子网是私有的（非IGW的路由）。

每个路由表均包含一个称为本地路由的默认路由，该默认路由无法修改或删除，可在Amazon VPC中进行通信。 您可以添加其他路由，以引导流量通过IGW（稍后讨论），VPG（稍后讨论）或NAT实例（稍后讨论）退出Amazon VPC。

关于路由表，以下关键点须牢记：

• VPC具有隐式路由器。

• VPC默认带有一个主路由表，您可以对其进行修改。

• 可以为VPC创建其他自定义路由表。

• 每个子网必须与一个路由表相关联。 如果您未将子网与特定的路由表明确关联，则该子网使用主路由表。

• 主路由表可被自定义路由表替换，以便每个新子网将自动与其关联。

表中的每个路由都指定一个目标CIDR和一个目标。

# Internet网关

Internet网关（IGW）是水平扩展高度可用的Amazon VPC组件，它是Amazon VPC实例与Internet通信的桥梁。 IGW在您的Amazon VPC路由表中为可路由Internet的流量提供了目标，并且它为已分配了公共IP地址的实例执行网络地址转换。

在VPC中, EC2实例仅知道其私有IP地址。 当流量从实例发送到Internet时，IGW会将返回地址转换为实例的公用IP地址（或EIP地址，稍后介绍），并维护实例专用IP地址和公用IP地址的一对一映射。 当实例从Internet接收流量时，IGW会将目标地址（公共IP地址）转换为实例的私有IP地址，并将流量转发到Amazon VPC。

您必须执行以下操作才能创建可以访问Internet的公共子网：

• 将IGW附加到您的Amazon VPC。

• 创建一个子网路由表规则，以将所有非本地流量（0.0.0.0/0）发送到IGW。

• 配置网络ACL和安全组规则，以允许相关流量往返于您的实例。

您必须执行以下操作才能使Amazon EC2实例能够从Internet发送和接收流量：

• 分配公共IP地址或EIP地址。

您可以将路由范围扩展到路由表（0.0.0.0/0）中的所有目标，也可以将路由范围缩小到较小的IP地址范围。

# DHCP 选项集合

动态主机配置协议 \(DHCP\) 提供了将配置信息传递到 TCP/IP 网络中主机的标准。DHCP消息的选项字段包含配置参数。 其中一些参数是域名，域名服务器和netbios-node-type。

在您创建Amazon VPC时，AWS会自动创建并关联DHCP选项集，并设置两个选项：域名服务器（默认为AmazonProvidedDNS）和域名（默认为您所在地区的域名）。

DHCP选项set元素允许您将Amazon EC2主机名指向您自己的资源。  您可以在DHCP选项集中配置以下值：

• domain-name-servers——最多四台域名服务器 \(即 AmazonProvidedDNS\) 的 IP 地址。默认 DHCP 选项集指定 AmazonProvidedDNS。如果指定的域名服务器不止一台，请使用逗号将它们隔开。尽管可以指定最多四个域名服务器，但请注意，某些操作系统可能会施加较低的限制。如果要让实例接收 domain-name 中指定的自定义 DNS 主机名，则必须将 domain-name-servers 设置为自定义 DNS 服务器。

• domain-name——如果您是在 us-east-1 中使用 AmazonProvidedDNS，请指定 ec2.internal。如果您是在其他区域中使用 AmazonProvidedDNS，请指定 region.compute.internal（例如 ap-northeast-1.compute.internal）。否则，请指定域名 \(例如 example.com\)。该值用于完成非限定的 DNS 主机名。

• ntp-servers——最多四个网络时间协议 \(NTP\) 服务器的 IP 地址。

• netbios-name-servers——最多四个 NetBIOS 名称服务器的 IP 地址。

• netbios-node-type——NetBIOS 节点类型 \(1、2、4 或 8\)。

# Elastic IP Addresses

AWS在每个区域均维护一个公共IP地址资源池，您可以将其与VPC中的资源关联。 弹性IP地址（EIP）是池中用于分配、释放的静态公共IP地址。 EIP允许您维护一组固定的IP地址，而不受架构变化影响。使用EIP有以下要点：

您须先分配一个EIP，然后才能将其链接到实例；

EIP是在特定区域内的，不可跨区使用；

您可以将EIP转移给另一个实例使用；

EIP与您的账号关联，直到释放为止；

EIP分配即收费。

# Elastic Network Interfaces

弹性网络接口（ENI）是一个虚拟网络接口，可以附加到VPC中的实例。ENI仅在VPC中可用，并且在创建时便与子网关联。他们具有一个公用IP和多个私有IP。如果他们拥有多个私有IP，则有一个是主要地址。通过分配多个网络接口，使实例拥有多个网卡（虚拟）。ENI不依附于实例存在，如果实例失效，可将其转移到别的实例。

# Peering

Peering是两个VPC之间的对等连接，使VPC可以像在同一个网络中通信。Peering可以在您自己创建的VPC间建立，也可以是在同一个区域里的不同账户常见的VPC。Peering不是网关，也不是VPN，不会引入通信单点故障。

Peering通过请求/接收协议实现，由VPC管理者向其他VPC发送请求来发起Peering连接。如果VPC在同一个账户下，请求由VPC ID标识，若在不同账户，则由账户ID+VPC ID组成识别key值。接收者有一个星期的时间来决定接受/拒绝连接请求，或者在请求失效时间之前。

Peering不支持传递，即假设有VPC A,B,C。A和B连接，B和C连接，但A不能因此而能够与C通信，因为Peering不支持传递，必须显示创建A和C的连接。



# Security Groups

安全组是一个虚拟状态防火墙，它控制到AWS资源和Amazon EC2实例的进出流量。AWS规定所有EC2实例启动到安全组中。 如果实例在启动时未指定安全组，则实例将被启动到默认安全组中。 默认安全组允许安全组内所有资源之间的通信，允许所有出站流量，并拒绝所有其他流量。 您可以更改默认安全组的规则，但不能删除默认安全组。 

安全组相关要点如下：

• 每个Amazon VPC最多可以创建500个安全组。

• 每个安全组最多可以添加50个入站规则和50个出站规则。

• 您可以指定允许规则，但不能拒绝规则。这是安全组和ACL之间的重要区别。

• 您可以为入站和出站流量分别指定规则。

• 默认情况下，除非将入站规则添加到安全组，否则不允许入站流量。

• 默认情况下，新的安全组具有一个出站规则，该规则允许所有出站流量。

• 您可以删除规则并添加仅允许特定出站流量的出站规则。

• 除非您添加允许的规则（默认安全组除外），否则与同一安全组关联的实例将无法相互通信。

您可以在启动后更改与实例关联的安全组，这些更改将立即生效。





# Network Access Control Lists \(ACLs\)

网络访问控制列表（ACL）是安全的另一层设置，它充当子网级别的无状态防火墙。 ACL是有编号排序的列表，AWS会从编号最小的规则开始按顺序评估这些规则，以确定是否允许流量进出任何与该网络ACL相关联的子网。 VPC创建时会自动带上一个默认的ACL，允许所有入站和出站流量。 创建自定义网络ACL时，初始设置将拒绝所有入站和出站流量，直到您创建允许规则。

 您可以使用与您的安全组类似的规则来设置网络ACL，以便为您的Amazon VPC添加一层安全保护，或者您可以选择使用不过滤流量的默认网络ACL。 总体而言，每个子网都必须与一个网络关联ACL。





# Network Address Translation \(NAT\) Instances and NAT 

默认情况下，您在私有子网的实例不能通过IGW与Internet通信。这对需要与Internet接触的实例来说是有问题的。AWS提供了NAT实例和NAT网关来解决这个问题。一般来说，我们建议您使用NAT网关，已获得更好的实用性和拓展性，并且管理的工作更少。



## NAT实例

NAT实例是一种 Linux机器映像（AMI），旨在接受来自私有子网内实例的流量，通过将源IP地址转换为NAT实例的公共IP地址的方式，重定向到IGW。 NAT实例维护转发流量的状态，以便将响应从Internet返回到专用子网中的实例。 这些实例的名称中包含字符串amzn-ami-vpc-nat，可在Amazon EC2控制台中进行搜索。

为实现私有子网下的实例通过NAT实例访问Internet资源，必须执行以下操作：

	• 为NAT创建一个安全组，设置一套出站规则，通过端口、协议和IP指定Internet资源

	• 禁用NAT的“源/目标检查”属性

	• 配置与专用子网关联的路由表，以将Internet绑定流量定向到NAT实例

	• 分配一个EIP并将其与NAT实例相关联

此配置允许专用子网中的实例发送出站通信，阻止实例接收从Internet发起的入站流量。



## NAT网关

NAT网关是Amazon托管的资源，像NAT实例一样运行，但它更易于管理并且在可用区中具有高可用性。

为实现专用子网内的实例通过NAT网关访问Internet资源，必须执行以下操作：

	• 配置与专用子网关联的路由表，以将Internet绑定的流量定向到NAT网关

	• 分配一个EIP并将其与NAT网关关联

像NAT实例一样，此配置允许专用子网中的实例发送出站通信，阻止实例接收从Internet发起的入站流量。



# VPG，CGW和VPN

您可以使用软硬VPN把数据中心与VPC连接从而扩展数据中心。AWS提供了两种连接方式：VPG和CGW。



VPG（Virtual private gateway）是AWS端的VPN集中器，而CGW（Customer gateway）是在客户端VPN设备或软件，创建VPG和CGW之后，最后一步是创建VPN通道。

您必须在创建VPN连接时就指定计划使用的路由类型。 如果CGW支持边界网关协议（BGP），则将VPN连接配置为动态路由。 否则，请配置为静态路由。 如果要使用静态路由，则必须输入网络中应传达给VPG的路由。 路由将传播到Amazon VPC，以使您的资源通过VGW并通过VPN隧道将网络流量路由回到公司网络。路由将传递给VPC，以使你的资源从VGW通过VPN通道返回公司网络。

VPC还支持多个CGW，每个CGW都具有到单个VPG（多对一）的VPN连接。 为了支持此拓扑连接，CGW IP地址在区域内必须唯一。

Amazon VPC将提供网络管理员所需的信息，以配置CGW并与VPG建立VPN连接。 VPN连接由两个Internet协议安全性（IPSec）隧道组成，以提高对Amazon VPC的可用性。





